---
title: "Démonstrateur ASPE : Construction des éléments non géographiques"
author: "Pascal Irz"
date: "`r format(Sys.time(), 'Le %d %B %Y')`"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Chargement des packages et des données

```{r}
library(aspe)
library(tidyverse)
```


```{r, echo = FALSE}
load(file = "../processed_data/captures.RData")
load(file = "../raw_data/mei.RData")
load(file = "../raw_data/toutes_tables_aspe_sauf_mei.RData")
```

```{r, eval = FALSE}
load(file = "processed_data/captures.RData")
load(file = "raw_data/mei.RData")
load(file = "raw_data/toutes_tables_aspe_sauf_mei.RData")
```


# df1 : espèce - opération

### densité

```{r}
df1 <- captures %>% 
  mutate(dens_ind_1000m2 = 1000 * effectif / ope_surface_calculee) %>% 
  select(-ope_surface_calculee)
```

### longueur des individus

Calcul des longueurs mini, maxi, moyenne et médiane pour chaque espèce à chaque opération. On ne tient pas compte du type de longueur (fourche ou totale).

```{r}
df1 <- df1 %>% 
  mef_ajouter_stats_taille()
```


### Apparitions / dispartitions d'espèces

Il s'agit ici de caractériser la dynamique - à l'échelle du point de prélèvement - des apparitions et disparitions d'espèces au fil du temps. On appelle ici colonisation le fait qu'une espèce soit capturée lors d'une opération alors qu'elle était absente lors de la précédente. A l'inverse, on désigne par le terme extinction l'absence d'une espèce dans l'échantillonnage alors qu'elle avait été capturée lors de la précédente prospection. 

>NB cette opération sur l'ensemble de la base prend environ 15 minutes.

```{r, echo = FALSE}
load(file = "../processed_data/colo_ext1.RData")
```


```{r, eval = FALSE}
colo_ext1 <- df1 %>%
  mef_colo_ext_pops() %>%
  ungroup()
```


```{r, eval = FALSE}
save(colo_ext1, file = "processed_data/colo_ext1.RData")
```



```{r}
df1 <- colo_ext1 %>%
  select(-effectif) %>% 
  left_join(y = df1)
```


### Visualisation d'un échantillon

```{r}
df1 %>%
  sample_n(10) %>%
  DT::datatable() %>%
  DT::formatRound(columns = c('dens_ind_1000m2', 'taille_moy'),
                  digits = 2)
```


# df2 : peuplement - opération

### Agrégation

```{r}
df2 <- df1 %>% 
  group_by(pop_id, ope_id, annee) %>% 
    summarise(richesse = n_distinct(esp_code_alternatif),
              effectif = sum(effectif, na.rm = TRUE),
              dens_ind_1000m2 = sum(dens_ind_1000m2, na.rm = TRUE)) %>% 
  ungroup()
```

### Apparitions / dispartitions d'espèces

Dénombrement des colonisations / extinction par point chaque année.

```{r}
colo_ext2 <- colo_ext1 %>%
  group_by(annee, pop_id) %>%
    summarise(n_colo = sum(col_ext == "colonisation"),
              n_ext = sum(col_ext == "extinction")) %>% 
  ungroup()
```

Ajout au dataframe.

```{r}
df2 <- df2 %>% 
  left_join(colo_ext2)
```

### IPR

Rajout des valeurs IPR, des métriques et des classes de qualité. Les autres variables (valeurs théoriques et observées des métriques) sont supprimées.

```{r}
df2 <- df2 %>%
  mef_ajouter_metriques() %>% 
  mef_ajouter_ipr() %>% 
  select(-(ner_theorique:dti_observe))
```

# df3 : espece - n opérations

### Complétion du df

Comme les données enregistrées dans la base sont les captures, les effectifs ne sont jamais nuls. Il faut donc compléter le tableau de données par espèce pour distinguer les années où il y a eu prospection sans capture de l'espèce des années où il n'y a pas eu prospection.

```{r}
df3 <- df1 %>% 
  group_by(esp_code_alternatif, annee) %>% 
    summarise(n_pres = sum(effectif > 0, na.rm = T)) %>% 
  ungroup() %>% 
  complete(annee, esp_code_alternatif, fill = list(n_pres = 0))

opes_par_an <- df1 %>% 
  group_by(annee) %>% 
    summarise(n_ope = n_distinct(ope_id)) %>% 
  ungroup()
  
df3 <- df3 %>% 
  left_join(y = opes_par_an) %>% 
  mutate(pc_pres = 100 * n_pres / n_ope)
```


# Paramètres environnementaux

Les paramètres environnementaux peuvent être utilisés pour caractériser le macro-habitat des espèces. On peut par exemple calculer l'altitude moyenne des sites où une espèce a été détectée et l'interpréter en regard de l'altitude moyenne sites où elle n'a pas été détectée ou de celle des sites prospectés. Pour cet usage il est essentiel de ne conserver que les opérations réalisées dans un but d'inventaire, donc d'écarter les indices d'abondance qui, focalisés sur une des espèces, ne renseignent pas sur les autres.

```{r}
ref_protocole %>% knitr::kable()
```

Retenons les protocoles 1 à 3 (respectivement Pêche complète à un ou plusieurs passages, Pêche partielle par points dans les grands milieux et Pêche par ambiances). L'inclusion de la modalité 4 - Pêche partielle sur berge - est à débattre.

Ces paramètres peuvent être trouvés soit dans la table `operation_ipr` car ils servent au calcul de l'indice, soit dans la table `point_prelevement`. Ici nous choisissons d'associer les paramètres à l'opération. S'ils sont manquants, on les complète à partir des informations de la table `point_prelevement`.

Si l'on veut simplement compléter le tableau des captures avec les données environnementales, on utilise `mef_ajouter_ope_env()` :

```{r,eval = FALSE}
df1_env <- df1 %>% 
  mef_ajouter_ope_env()
```

Si l'on veut comparer les caractéristiques des points de présence et d'absence d'une espèce donnée, on doit faire apparaître les absences dans les échantillons en complétant le tableau :

```{r}
captures_et_env <- df1 %>%
  droplevels() %>% # à retirer à terme
  select(ope_id, esp_code_alternatif, effectif, dens_ind_1000m2) %>% 
  complete(ope_id,
           esp_code_alternatif,
           fill = list(effectif = 0,
                       dens_ind_1000m2 = 0)) %>% 
  left_join(y =  df1 %>%
                  select(ope_id, annee) %>% 
                  distinct()) %>% 
  left_join(y = operation %>%
              select(ope_id, pop_id = ope_pop_id)) %>% 
  mef_ajouter_ope_env() %>% 
  pivot_longer(
    cols = distance_mer:temp_janvier,
    names_to = "parametre",
    values_to = "valeur",
    values_drop_na = TRUE
  )
```

```{r}
mon_espece <- "TRF" 
mon_parametre <- "altitude"

captures_et_env %>% 
  filter(esp_code_alternatif == mon_espece,
         parametre == mon_parametre) %>% 
  ggplot(aes(x = valeur, fill = effectif > 0)) +
    geom_density(alpha = 0.1) +
    labs(x = mon_parametre, y = "Densité", title = mon_espece)

```

Tout ça amène à manipuler des dataframes volumineux donc suggère de tester des alternatives


```{r}
ope_env <- df1 %>% 
  select(ope_id, pop_id) %>% 
  mef_ajouter_ope_env() %>% 
  distinct() %>% 
  pivot_longer(
    cols = distance_mer:temp_janvier,
    names_to = "parametre",
    values_to = "valeur",
    values_drop_na = TRUE)  
  
```

```{r}
mon_espece <- "TRF" 
mon_parametre <- "altitude"

data <- df1 %>% 
  select(pop_id, ope_id, esp_code_alternatif, effectif, dens_ind_1000m2) %>%  
  filter(esp_code_alternatif == mon_espece) %>%
  left_join(ope_env) %>% 
  complete(ope_id,
           esp_code_alternatif,
           fill = list(effectif = 0,
                       dens_ind_1000m2 = 0)) %>% 
  left_join(y =  df1 %>%
                  select(ope_id, annee) %>% 
                  distinct())
  

ggplot(data = data,
       aes(x = valeur)) +
    geom_density(alpha = 0.1) +
    labs(x = mon_parametre, y = "Densité", title = mon_espece)

data <- df1 %>%
  droplevels() %>% # à retirer à terme
  select(ope_id, esp_code_alternatif, effectif, dens_ind_1000m2) %>% 
  complete(ope_id,
           esp_code_alternatif,
           fill = list(effectif = 0,
                       dens_ind_1000m2 = 0)) %>% 
  left_join(y =  df1 %>%
                  select(ope_id, annee) %>% 
                  distinct()) %>% 
  left_join(y = operation %>%
              select(ope_id, pop_id = ope_pop_id)) %>% 
  mef_ajouter_ope_env() %>% 
  pivot_longer(
    cols = distance_mer:temp_janvier,
    names_to = "parametre",
    values_to = "valeur",
    values_drop_na = TRUE
  )

mon_espece <- "TRF" 
mon_parametre <- "altitude"

captures_et_env %>% 
  filter(esp_code_alternatif == mon_espece,
         parametre == mon_parametre) %>% 
  ggplot(aes(x = valeur, fill = effectif > 0)) +
    geom_density(alpha = 0.1) +
    labs(x = mon_parametre, y = "Densité", title = mon_espece)
```










# Sauvegarde des dataframes

```{r, echo = FALSE}
save(df1, file = "../processed_data/df1.RData")
save(df2, file = "../processed_data/df2.RData")
```

```{r, eval = FALSE}
save(df1, file = "processed_data/df1.RData")
save(df2, file = "processed_data/df2.RData")
```