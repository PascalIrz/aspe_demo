---
title: "Démonstrateur ASPE : Construction des éléments non géographiques"
author: "Pascal Irz"
date: "`r format(Sys.time(), 'Le %d %B %Y')`"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Chargement des packages et des données

```{r}
library(aspe)
library(tidyverse)
```


```{r, echo = FALSE}
load(file = "../processed_data/captures.RData")
load(file = "../raw_data/mei.RData")
load(file = "../raw_data/toutes_tables_aspe_sauf_mei.RData")
```

```{r, eval = FALSE}
load(file = "processed_data/captures.RData")
load(file = "raw_data/mei.RData")
load(file = "raw_data/toutes_tables_aspe_sauf_mei.RData")
```


# df1 : espèce - opération

### densité

```{r}
df1 <- captures %>% 
  mutate(dens_ind_1000m2 = 1000 * effectif / ope_surface_calculee)
```

### longueur des individus

Calcul des longueurs mini, maxi, moyenne et médiane pour chaque espèce à chaque opération. Si le type de longueur n'est pas renseigné, on considère que c'est le cas le plus fréquent donc la longueur totale (`tlo_id = 2`).

```{r}
longueurs <- mef_creer_passerelle() %>%
  mef_ajouter_lots() %>%
  select(ope_id, lop_id, esp_code_alternatif) %>%
  distinct() %>%
  right_join(y = mesure_individuelle %>%
               rename(lop_id = mei_lop_id,
                      tlo_id = mei_tlo_id)) %>%
  group_by(ope_id, esp_code_alternatif) %>%
  summarise(
    taille_max = max(mei_taille, na.rm = TRUE),
    taille_min = min(mei_taille, na.rm = TRUE),
    taille_moy = mean(mei_taille, na.rm = TRUE),
    taille_med = median(mei_taille, na.rm = TRUE)
  ) %>%
  ungroup() %>%
#  left_join(y = ref_type_longueur) %>%
  select(ope_id,
         esp_code_alternatif,
 #        tlo_libelle,
         starts_with("taille_"))
```

Ajout de ces longueurs 

```{r}
df1 <- df1 %>% 
  left_join(longueurs) %>% 
  select(-ope_surface_calculee)
```

Visualisation d'un échantillon.

```{r}
df1 %>%
  sample_n(10) %>%
  DT::datatable() %>%
  DT::formatRound(columns = c('dens_ind_1000m2', 'taille_moy'),
                  digits = 2)
```

# df2 : peuplement - opération

### Agrégation

```{r}
df2 <- df1 %>% 
  group_by(pop_id, ope_id, annee) %>% 
    summarise(richesse = n_distinct(esp_code_alternatif),
              effectif = sum(effectif, na.rm = TRUE),
              dens_ind_1000m2 = sum(dens_ind_1000m2, na.rm = TRUE))
```

### Apparitions / dispartitions d'espèces

>NB cette opération sur l'ensemble de la base prend environ 15 minutes.

```{r, eval = FALSE}
colo_ext <- df1 %>% 
  mef_colo_ext_pops() %>% 
  ungroup() %>% 
  group_by(pop_id, annee) %>% 
    summarise(n_colo = sum(col_ext == "colonisation"),
              n_ext = sum(col_ext == "extinction"))
```

```{r, echo = FALSE}
load(file = "../processed_data/colo_ext.RData")
```

```{r}
df2 <- df2 %>% 
  left_join(colo_ext, by = c("pop_id", "annee")) %>%
  ungroup()
```

### IPR

```{r}
df2 <- df2 %>%
  mef_ajouter_metriques() %>% 
  mef_ajouter_ipr()
```

# df3 : espece - n opérations

### Complétion du df

Comme les données enregistrées dans la base sont les captures, les effectifs ne sont jamais nuls. Il faut donc compléter le tableau de données par espèce pour distinguer les années où il y a eu prospection sans capture de l'espèce des années où il n'y a pas eu prospection.

```{r}
df_prov <- df1 %>% 
  select(pop_id, annee, esp_code_alternatif, effectif) %>%
  mutate(esp_code_alternatif = as.character(esp_code_alternatif)) %>% 
  group_by(pop_id) %>% 
    complete(annee, esp_code_alternatif, fill = list(effectif = 0))

df3 <- df_prov %>% 
  group_by(esp_code_alternatif, annee) %>% 
    summarise(n_pres = sum(effectif > 0, na.rm = T),
              n_ech = n())


```




# Sauvegarde des dataframes

```{r, echo = FALSE}
save(colo_ext, file = "../processed_data/colo_ext.RData")
save(df1, file = "../processed_data/df1.RData")
save(df2, file = "../processed_data/df2.RData")
```

```{r, eval = FALSE}
save(colo_ext, file = "processed_data/colo_ext.RData")
save(df1, file = "processed_data/df1.RData")
save(df2, file = "processed_data/df2.RData")
```